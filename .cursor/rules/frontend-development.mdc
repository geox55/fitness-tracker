---
description: Frontend development rules for Fitness Tracker UI
globs:
  - "packages/frontend/**/*"
alwaysApply: false
---

# Frontend Development Rules

## Reference Documentation

**Обязательно к прочтению:**
- Architecture: `docs/spec/02-architecture.md`
- UI/UX Guidelines: `docs/spec/05-ui-ux-guidelines.md`
- Testing: `docs/spec/04-testing-strategy.md`
- Role Guide: `docs/spec/roles/frontend-developer.md`

## TypeScript & Code Quality Guidelines

### Code Style and Structure
- Write concise, technical TypeScript code with accurate examples
- Use functional and declarative programming patterns; avoid classes
- Favor iteration and modularization over code duplication
- Use descriptive variable names with auxiliary verbs: `isLoading`, `hasError`, `canDelete`
- Structure files with exported components, subcomponents, helpers, static content, and types
- Use lowercase with dashes for directory names: `components/auth-wizard`

### React Best Practices
- Minimize the use of `useEffect` and `setState` - prefer derived state when possible
- Use React hooks for state management and side effects
- Implement code splitting with dynamic imports for optimization
- Use responsive design with a mobile-first approach
- Optimize images: use WebP format, include size data, implement lazy loading

### Error Handling and Validation
- Prioritize error handling and edge cases
- Use early returns for error conditions
- Implement guard clauses to handle preconditions and invalid states early
- Use custom error types for consistent error handling
- Implement validation using Zod for schema validation

### Security and Performance
- Implement proper error handling, user input validation, and secure coding practices
- Follow performance optimization techniques: reduce load times, improve rendering efficiency
- Use create-gstore for global state (session, config) and TanStack Query for server state
- Use openapi-react-query for type-safe API calls with automatic type generation

## FSD Architecture

### Project Structure

```
src/
├── app/                            # Application entry, routing, providers
│   ├── app.tsx                     # Main app component with Outlet
│   ├── router.tsx                  # React Router v7 configuration
│   ├── providers.tsx               # QueryClientProvider, ThemeProvider
│   ├── main.tsx                    # Entry point with MSW setup
│   ├── protected-toute.tsx         # Protected route wrapper
│   └── root-error-boundary.tsx    # Error boundary
├── features/                       # Business features (FSD)
│   └── feature-name/
│       ├── ui/                     # UI компоненты фичи
│       ├── model/                  # Бизнес-логика, хуки
│       ├── *.page.tsx              # Page components (React Router)
│       └── index.ts                # Public API фичи
└── shared/                         # Reusable modules
    ├── api/
    │   ├── instance.ts             # openapi-fetch client
    │   ├── query-client.ts         # TanStack Query client
    │   ├── schema/                 # OpenAPI schema files
    │   │   ├── main.yaml
    │   │   ├── endpoints/
    │   │   └── generated.ts        # Generated types (run `pnpm api`)
    │   └── mocks/                  # MSW handlers
    ├── ui/kit/                     # shadcn/ui components
    ├── lib/                        # Utils (css, format)
    ├── model/                      # Global state (create-gstore)
    │   ├── session.ts              # Auth session management
    │   ├── routes.ts               # Route constants
    │   └── config.ts               # App config
    └── index.ts                    # Публичный API shared
```

### Layer Organization Rules

#### App Layer
- **Purpose**: Global application configuration
- **Contains**: Providers, routing, global styles, configuration
- **Imports**: Only from `shared` and `features`
- **Exports**: Application entry point

```typescript
// app/providers.tsx
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from '@/shared/api/query-client';
import { ThemeProvider } from '@/shared/ui/kit/theme-provider';

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <QueryClientProvider client={queryClient}>
      <ThemeProvider defaultTheme="light" storageKey="vite-ui-theme">
        {children}
      </ThemeProvider>
    </QueryClientProvider>
  );
}
```

#### Features Layer
- **Purpose**: Business features of the application
- **Structure**: Each feature is isolated
- **Imports**: Only from `shared` and other `features`
- **Exports**: Public API through `index.ts`

```typescript
// features/workout-logging/ui/WorkoutForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Button } from '@/shared/ui/kit/button';
import { Form, FormField, FormItem, FormLabel, FormControl, FormMessage } from '@/shared/ui/kit/form';
import { useAddWorkout } from '../model/useWorkoutForm';

export function WorkoutForm() {
  const form = useForm({
    resolver: zodResolver(workoutSchema),
    defaultValues: { exerciseId: '', weight: 0, reps: 0 },
  });
  const { mutate, isPending } = useAddWorkout();
  // ...
}

// features/workout-logging/model/useAddWorkout.ts
import { useMutation } from '@tanstack/react-query';
import { rqClient } from '@/shared/api/instance';
import type { paths } from '@/shared/api/schema';

export function useAddWorkout() {
  return useMutation({
    mutationFn: async (data: paths['/api/workouts']['post']['requestBody']['content']['application/json']) => {
      const { data: result, error } = await rqClient.POST('/api/workouts', { body: data });
      if (error) throw new Error(error.message);
      return result;
    },
    // ...
  });
}
```

#### Shared Layer
- **Purpose**: Reusable modules
- **Structure**: Organized by resource types
- **Imports**: Only within `shared`
- **Exports**: Public API through `index.ts`

```typescript
// shared/ui/kit/button.tsx (from shadcn/ui)
import { Button as ShadcnButton } from '@/components/ui/button';
import { cn } from '@/shared/lib/css';

export const Button = ({ className, ...props }) => {
  return <ShadcnButton className={cn(className)} {...props} />;
};

// shared/api/instance.ts
import createFetchClient from 'openapi-fetch';
import createClient from 'openapi-react-query';
import type { paths } from './schema';

export const fetchClient = createFetchClient<paths>({
  baseUrl: CONFIG.API_BASE_URL,
});

export const rqClient = createClient(fetchClient);

// Auto-add JWT token
fetchClient.use({
  async onRequest({ request }) {
    const token = await useSession.getState().refreshToken();
    if (token) {
      request.headers.set('Authorization', `Bearer ${token}`);
    }
  },
});
```

### Import Rules

**Allowed imports:**
- ✅ `app` → `features`, `shared`
- ✅ `features` → `shared`, other `features`
- ✅ `shared` → only within `shared`

**Forbidden imports:**
- ❌ `shared` → `features`
- ❌ `shared` → `app`
- ❌ `features` → `app`

### Feature Structure

#### Simple Feature
```
features/workout-logging/
├── ui/
│   └── WorkoutForm.tsx
├── model/
│   └── useWorkoutForm.ts
└── index.ts
```

#### Complex Feature
```
features/workout-history/
├── ui/
│   ├── WorkoutList.tsx
│   ├── WorkoutCard.tsx
│   ├── WorkoutFilters.tsx
│   └── index.ts
├── model/
│   ├── useWorkouts.ts
│   ├── useWorkoutFilters.ts
│   ├── workoutStore.ts
│   └── index.ts
├── types.ts
└── index.ts
```

### Feature Layer Details

#### UI Components (features/*/ui/)
- Contain only presentation logic
- Receive data through props or hooks
- Do NOT contain business logic

```typescript
// features/workout-logging/ui/WorkoutForm.tsx
interface WorkoutFormProps {
  onSuccess?: () => void;
}

export const WorkoutForm = ({ onSuccess }: WorkoutFormProps) => {
  const { addWorkout, isLoading } = useAddWorkout();
  
  const handleSubmit = (data: WorkoutInput) => {
    addWorkout(data, { onSuccess });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      {/* Form fields */}
    </form>
  );
};
```

#### Model Layer (features/*/model/)
- Contains business logic
- Hooks for data management (TanStack Query)
- API calls using openapi-react-query
- Form validation schemas (Zod)

```typescript
// features/workout-logging/model/useAddWorkout.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { rqClient } from '@/shared/api/instance';
import type { paths } from '@/shared/api/schema';

type CreateWorkoutRequest = paths['/api/workouts']['post']['requestBody']['content']['application/json'];

export function useAddWorkout() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (data: CreateWorkoutRequest) => {
      const { data: result, error } = await rqClient.POST('/api/workouts', { body: data });
      if (error) throw new Error(error.message);
      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['workouts'] });
    }
  });
}
```

### Public API Pattern

#### Feature Exports (features/*/index.ts)
```typescript
// features/workout-logging/index.ts
export { WorkoutForm } from './ui';
export { useAddWorkout } from './model';
export type { WorkoutInput, WorkoutLog } from './types';
```

#### Shared Exports (shared/index.ts)
```typescript
// shared/index.ts
export * from './ui';
export * from './api';
export * from './lib';
export * from './model';
```

### File Naming Conventions

- **Components**: PascalCase - `WorkoutForm.tsx`
- **Folders**: kebab-case - `workout-form/`
- **Hooks**: camelCase with `use` prefix - `useWorkoutForm.ts`
- **Utils**: camelCase - `formatDate.ts`
- **Types**: PascalCase - `WorkoutTypes.ts`

## UI Components: shadcn/ui + Tailwind CSS v4

Базовые UI компоненты в `shared/ui/kit` построены на основе **shadcn/ui** — коллекции переиспользуемых компонентов, скопированных в проект. Используется **Tailwind CSS v4** через `@tailwindcss/vite`.

### Установка shadcn/ui

```bash
# В packages/frontend
cd packages/frontend
npx shadcn-ui@latest init
# Выбрать: Vite, TypeScript, New York style
npx shadcn-ui@latest add button input card form label
```

### Использование компонентов

Компоненты из shadcn/ui находятся в `shared/ui/kit/` и готовы к использованию:

```typescript
// Использование в компонентах
import { Button } from '@/shared/ui/kit/button';
import { Input } from '@/shared/ui/kit/input';
import { Form, FormField, FormItem, FormLabel, FormControl, FormMessage } from '@/shared/ui/kit/form';

// Для форм используйте React Hook Form + Zod
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import z from 'zod';

const schema = z.object({
  email: z.string().email('Неверный email'),
  password: z.string().min(6, 'Пароль должен быть не менее 6 символов'),
});

export function LoginForm() {
  const form = useForm({
    resolver: zodResolver(schema),
    defaultValues: { email: '', password: '' },
  });

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        <FormField
          control={form.control}
          name="email"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Email</FormLabel>
              <FormControl>
                <Input {...field} type="email" />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
      </form>
    </Form>
  );
}
```

### Доступные компоненты

- **Button** — `@/shared/ui/kit/button`
- **Input** — `@/shared/ui/kit/input`
- **Form** — `@/shared/ui/kit/form` (для React Hook Form)
- **Card** — `@/shared/ui/kit/card`
- **Label** — `@/shared/ui/kit/label`
- Все компоненты используют Tailwind CSS v4

## Component Pattern

```typescript
// packages/frontend/src/features/workout-logging/ui/WorkoutForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import z from 'zod';
import { Button } from '@/shared/ui/kit/button';
import { Form, FormField, FormItem, FormLabel, FormControl, FormMessage } from '@/shared/ui/kit/form';
import { Input } from '@/shared/ui/kit/input';
import { useAddWorkout } from '../model/useWorkoutForm';

const workoutSchema = z.object({
  exerciseId: z.string().min(1, 'Выберите упражнение'),
  weight: z.number().positive('Вес должен быть положительным'),
  reps: z.number().int().min(1).max(100),
});

interface WorkoutFormProps {
  onSuccess?: () => void;
}

export function WorkoutForm({ onSuccess }: WorkoutFormProps) {
  const form = useForm({
    resolver: zodResolver(workoutSchema),
    defaultValues: { exerciseId: '', weight: 0, reps: 0 },
  });
  
  const { mutate, isPending } = useAddWorkout();
  
  const onSubmit = form.handleSubmit((data) => {
    mutate(data, { onSuccess });
  });
  
  return (
    <Form {...form}>
      <form onSubmit={onSubmit} className="space-y-4">
        <FormField
          control={form.control}
          name="weight"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Вес (кг)</FormLabel>
              <FormControl>
                <Input
                  {...field}
                  type="number"
                  onChange={(e) => field.onChange(parseFloat(e.target.value) || 0)}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        <Button type="submit" disabled={isPending}>
          Добавить
        </Button>
      </form>
    </Form>
  );
}
```

## Model Hook Pattern

```typescript
// packages/frontend/src/features/workout-logging/model/useWorkoutForm.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { rqClient } from '@/shared/api/instance';
import type { paths } from '@/shared/api/schema';

type CreateWorkoutRequest = paths['/api/workouts']['post']['requestBody']['content']['application/json'];

export function useAddWorkout() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (data: CreateWorkoutRequest) => {
      const { data: result, error } = await rqClient.POST('/api/workouts', { body: data });
      if (error) throw new Error(error.message);
      return result;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['workouts'] });
    }
  });
}
```

## OpenAPI Schema and Type Generation

Типы API генерируются автоматически из OpenAPI схемы:

```bash
# Генерация типов из OpenAPI схемы
pnpm --filter front api
# Создает src/shared/api/schema/generated.ts
```

Использование типов:

```typescript
import type { paths } from '@/shared/api/schema';

// Request type
type CreateWorkoutRequest = paths['/api/workouts']['post']['requestBody']['content']['application/json'];

// Response type
type WorkoutResponse = paths['/api/workouts']['post']['responses']['201']['content']['application/json'];
```

## Routing: React Router v7

```typescript
// app/router.tsx
import { createBrowserRouter } from 'react-router';
import { ROUTES } from '@/shared/model/routes';

export const router = createBrowserRouter([
  {
    element: (
      <Providers>
        <App />
      </Providers>
    ),
    children: [
      {
        element: <ProtectedRoute />,
        children: [
          {
            path: ROUTES.WORKOUTS,
            lazy: () => import('@/features/workouts/workouts.page'),
          },
        ],
      },
    ],
  },
]);
```

## State Management: create-gstore

Для глобального состояния (сессия, конфиг) используется create-gstore:

```typescript
// shared/model/session.ts
import { createGStore } from 'create-gstore';
import { jwtDecode } from 'jwt-decode';

export const useSession = createGStore(() => {
  const [token, setToken] = useState(() => localStorage.getItem('token'));

  const login = (token: string) => {
    localStorage.setItem('token', token);
    setToken(token);
  };

  const logout = () => {
    localStorage.removeItem('token');
    setToken(null);
  };

  const session = token ? jwtDecode<Session>(token) : null;

  return { login, logout, session };
});
```

Для серверного состояния используйте TanStack Query.

## Styling Guidelines

### Use Tailwind CSS v4

```tsx
// ✅ Good - Tailwind utility classes
<Button className="bg-primary text-white hover:bg-primary/90 rounded-md px-4 py-2">
  Click me
</Button>

// ❌ Bad — inline styles or hardcoded values
<Button style={{ background: '#218081', borderRadius: '8px' }}>
  Click me
</Button>
```

### Custom Theme Variables

```css
/* src/app/main.css */
@theme {
  --color-primary: #218081;
  --color-text: #134252;
  --radius-md: 0.5rem;
}
```

### Color Palette

```css
--color-primary: #218081;      /* Teal */
--color-text: #134252;         /* Dark slate */
--color-text-secondary: #626C71;
--color-bg: #FCFCF9;           /* Cream light */
--color-surface: #FFFFFD;      /* Card background */
--color-error: #C0152F;
--color-success: #218081;
```

## Accessibility

```tsx
// ✅ Good
<input
  id="weight"
  aria-label="Weight in kilograms"
  aria-invalid={!!error}
  aria-describedby={error ? 'weight-error' : undefined}
/>
{error && <span id="weight-error" role="alert">{error}</span>}

// ❌ Bad — no accessibility attributes
<input value={weight} />
{error && <span>{error}</span>}
```

## Mock Service Worker (MSW)

MSW автоматически включается в development режиме для моков API.

### Creating Handlers

```typescript
// shared/api/mocks/handlers/workouts.ts
import { http, HttpResponse } from 'msw';

export const workoutHandlers = [
  http.post('/api/workouts', async ({ request }) => {
    const body = await request.json();
    return HttpResponse.json({
      id: 'workout-1',
      ...body,
      createdAt: new Date().toISOString(),
    }, { status: 201 });
  }),

  http.get('/api/workouts', () => {
    return HttpResponse.json({
      data: [{ id: '1', exerciseId: 'ex1', weight: 100, reps: 5 }],
    });
  }),
];
```

### Registering Handlers

```typescript
// shared/api/mocks/browser.ts
import { setupWorker } from 'msw/browser';
import { workoutHandlers } from './handlers/workouts';
import { authHandlers } from './handlers/auth';

export const worker = setupWorker(...workoutHandlers, ...authHandlers);
```

MSW автоматически запускается в `app/main.tsx` в development режиме.

## Testing and Documentation

### Testing Principles
- Write unit tests for components using Vitest and React Testing Library
- Follow Arrange-Act-Assert convention for tests
- Test user interactions, not implementation details
- Use `data-testid` for reliable selectors in E2E tests
- Mock API calls using MSW handlers in tests

### Testing Example with React Hook Form

```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { WorkoutForm } from '@/features/workout-logging';

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: { queries: { retry: false } }
  });
  
  return ({ children }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

describe('WorkoutForm', () => {
  it('should show error for empty exercise', async () => {
    render(<WorkoutForm />, { wrapper: createWrapper() });
    
    fireEvent.click(screen.getByText(/добавить/i));
    
    expect(await screen.findByText(/выберите упражнение/i)).toBeInTheDocument();
  });
});
```

### Documentation
- Provide clear and concise comments for complex logic
- Use JSDoc comments for functions and components to improve IDE intellisense
- Document component props with TypeScript interfaces

## Data Attributes for Testing

```tsx
// Use data-testid for E2E tests
<button data-testid="add-set-btn">Add Set</button>
<input data-testid="weight-input" />
<div data-testid="set-list">{sets}</div>
```

## Development Methodology

### Approach
1. **Deep Dive Analysis**: Conduct thorough analysis of requirements and constraints
2. **Planning**: Develop clear plan outlining architectural structure and flow
3. **Implementation**: Implement step-by-step, ensuring best practices
4. **Review and Optimize**: Review code for optimization opportunities
5. **Finalization**: Ensure code meets requirements, is secure, and performant

### Thinking Process
- **System 2 Thinking**: Approach with analytical rigor, break down into manageable parts
- **Tree of Thoughts**: Evaluate multiple solutions and consequences
- **Iterative Refinement**: Consider improvements, edge cases, and optimizations before finalizing

## Anti-patterns

### ❌ Incorrect - Business Logic in UI
```typescript
// features/workout-logging/ui/WorkoutForm.tsx
import { rqClient } from '@/shared/api/instance';
import { useState } from 'react';

export function WorkoutForm() {
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async (data: WorkoutInput) => {
    setLoading(true);
    await rqClient.POST('/api/workouts', { body: data }); // Business logic in UI
    setLoading(false);
  };
}
```

### ✅ Correct - Logic in Model Layer with React Hook Form
```typescript
// features/workout-logging/ui/WorkoutForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Form, FormField, FormItem, FormLabel, FormControl, FormMessage } from '@/shared/ui/kit/form';
import { useAddWorkout } from '../model/useWorkoutForm';

export function WorkoutForm() {
  const form = useForm({
    resolver: zodResolver(workoutSchema),
    defaultValues: { exerciseId: '', weight: 0, reps: 0 },
  });
  
  const { mutate, isPending } = useAddWorkout();
  
  const onSubmit = form.handleSubmit((data) => {
    mutate(data); // Logic in model layer
  });
  
  return (
    <Form {...form}>
      <form onSubmit={onSubmit}>
        {/* Form fields */}
      </form>
    </Form>
  );
}

// features/workout-logging/model/useAddWorkout.ts
import { useMutation } from '@tanstack/react-query';
import { rqClient } from '@/shared/api/instance';
import type { paths } from '@/shared/api/schema';

export function useAddWorkout() {
  return useMutation({
    mutationFn: async (data: paths['/api/workouts']['post']['requestBody']['content']['application/json']) => {
      const { data: result, error } = await rqClient.POST('/api/workouts', { body: data });
      if (error) throw new Error(error.message);
      return result;
    },
    // ...
  });
}
```

### Common Anti-patterns
❌ Business logic in UI components  
❌ API calls directly in components (use model layer)  
❌ Inline styles (use Tailwind CSS)  
❌ Hardcoded colors/spacing (use Tailwind theme)  
❌ Missing loading/error states  
❌ Missing aria attributes  
❌ Overuse of `useEffect` - prefer derived state when possible  
❌ Missing image optimization - always use lazy loading  
❌ Importing from `shared` to `features` (violates FSD rules)  
❌ Importing from `features` to `app` (violates FSD rules)  
❌ Manual form validation (use React Hook Form + Zod)  
❌ Manual API type definitions (use OpenAPI schema generation)  
❌ Not using openapi-react-query for type-safe API calls

### Migration Guide

When refactoring existing code to FSD:

1. **Identify features** - Extract business features from monolithic components
2. **Create shared** - Move reusable parts to `shared` layer
3. **Separate UI and model** - Split presentation and business logic in each feature
4. **Setup public APIs** - Configure exports through `index.ts` files
5. **Verify imports** - Check all imports follow FSD rules
